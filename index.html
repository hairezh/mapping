<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>osu!mania Pack Builder (MVP)</title>
  <style>
    :root{
      --bg:#0b0c0f; --panel:#12141a; --panel2:#0f1116;
      --fg:#e8e8e8; --muted:#a0a6b3; --border:rgba(255,255,255,.10);
      --accent:#7aa2ff; --accent2:#77f2c6; --danger:#ff6b6b;
      --r:10px; --pad:14px; --fs:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:linear-gradient(180deg,#0b0c0f 0%, #07080b 100%);
      color:var(--fg); font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Arial;
      font-size:var(--fs);
    }
    header{
      padding:18px 18px 10px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .title{
      display:flex; flex-direction:column; gap:4px;
    }
    .title h1{margin:0; font-size:16px; letter-spacing:.2px}
    .title p{margin:0; color:var(--muted); font-size:12px}
    .wrap{
      padding:12px 18px 18px;
      display:grid; grid-template-columns: 380px 1fr; gap:12px;
    }
    @media (max-width: 980px){
      .wrap{grid-template-columns:1fr}
    }
    .card{
      background:rgba(255,255,255,.03);
      border:1px solid var(--border);
      border-radius:var(--r);
      padding:var(--pad);
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    .card h2{
      margin:0 0 10px; font-size:13px; color:#dfe6ff;
      letter-spacing:.2px;
    }
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .col{display:flex; flex-direction:column; gap:8px}
    label{font-size:12px; color:var(--muted)}
    input[type="file"], input[type="text"], input[type="number"]{
      width:100%;
      background:rgba(0,0,0,.25);
      border:1px solid var(--border);
      border-radius:8px;
      padding:10px 10px;
      color:var(--fg);
      outline:none;
    }
    input[type="number"]{max-width:140px}
    button{
      background:rgba(255,255,255,.06);
      border:1px solid var(--border);
      color:var(--fg);
      border-radius:8px;
      padding:10px 12px;
      cursor:pointer;
      transition:.15s transform, .15s background, .15s border;
      user-select:none;
    }
    button:hover{background:rgba(255,255,255,.10)}
    button:active{transform:scale(.98)}
    .primary{border-color:rgba(122,162,255,.5); background:rgba(122,162,255,.14)}
    .primary:hover{background:rgba(122,162,255,.20)}
    .danger{border-color:rgba(255,107,107,.45); background:rgba(255,107,107,.12)}
    .danger:hover{background:rgba(255,107,107,.18)}
    .mini{padding:8px 10px; font-size:12px}
    .pill{
      padding:6px 10px; border-radius:999px;
      border:1px solid var(--border);
      color:var(--muted);
      font-size:12px;
      background:rgba(0,0,0,.18);
    }
    .status{
      display:flex; flex-direction:column; gap:6px;
      font-size:12px; color:var(--muted);
      border-top:1px dashed rgba(255,255,255,.08);
      margin-top:12px; padding-top:12px;
    }
    .status b{color:var(--fg); font-weight:600}
    .previewWrap{
      display:flex; flex-direction:column; gap:10px;
    }
    .previewTop{
      display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;
    }
    .audioBar{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
    }
    .range{
      width:240px; max-width:100%;
    }
    canvas{
      width:100%;
      height:520px;
      background:rgba(0,0,0,.25);
      border:1px solid var(--border);
      border-radius:12px;
      display:block;
    }
    .small{
      font-size:12px; color:var(--muted);
    }
    .kbd{
      font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
      font-size:12px;
      padding:2px 6px;
      border:1px solid var(--border);
      border-radius:6px;
      background:rgba(0,0,0,.22);
      color:#d7dcff;
    }
  </style>
</head>
<body>
<header>
  <div class="title">
    <h1>osu!mania Pack Builder (MVP)</h1>
    <p>Carrega .osu + áudio + bg → preview → exporta .zip com tudo junto</p>
  </div>
  <div class="row">
    <span class="pill">Preview: piano-roll simples</span>
    <span class="pill">Export: ZIP</span>
  </div>
</header>

<div class="wrap">
  <!-- LEFT: inputs -->
  <section class="card">
    <h2>Arquivos</h2>
    <div class="col">
      <div>
        <label>Mapa (.osu) — modo mania</label>
        <input id="osuFile" type="file" accept=".osu,text/plain" />
      </div>
      <div>
        <label>Áudio (opcional) — .mp3/.ogg</label>
        <input id="audioFile" type="file" accept="audio/*" />
      </div>
      <div>
        <label>Background (opcional) — .png/.jpg</label>
        <input id="bgFile" type="file" accept="image/*" />
      </div>
    </div>

    <div style="height:12px"></div>

    <h2>Config</h2>
    <div class="row">
      <div class="col" style="flex:1; min-width:220px">
        <label>Nome do pack (pasta dentro do zip)</label>
        <input id="packName" type="text" placeholder="MeuPack_Mania" />
      </div>
      <div class="col">
        <label>Janela (ms) no preview</label>
        <input id="windowMs" type="number" min="2000" max="60000" step="500" value="12000" />
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <button id="exportZip" class="primary">Exportar .zip</button>
      <button id="resetAll" class="danger">Zerar tudo</button>
    </div>

    <div class="status" id="statusBox">
      <div><b>Mapa:</b> <span id="sMap">nenhum</span></div>
      <div><b>Áudio:</b> <span id="sAudio">nenhum</span></div>
      <div><b>BG:</b> <span id="sBg">nenhum</span></div>
      <div class="small">Atalhos: <span class="kbd">Space</span> play/pause • <span class="kbd">←</span>/<span class="kbd">→</span> seek</div>
    </div>
  </section>

  <!-- RIGHT: preview -->
  <section class="card previewWrap">
    <div class="previewTop">
      <div class="row" style="gap:8px">
        <span class="pill" id="metaKeys">Keys: -</span>
        <span class="pill" id="metaObjects">Objects: -</span>
        <span class="pill" id="metaBpm">BPM: (estimado) -</span>
      </div>

      <div class="audioBar">
        <button id="btnPlay" class="mini">Play</button>
        <button id="btnStop" class="mini">Stop</button>
        <input id="seek" class="range" type="range" min="0" max="1000" value="0" />
        <span class="pill" id="timeLabel">00:00.000</span>
      </div>
    </div>

    <canvas id="cv" width="1400" height="520"></canvas>
    <div class="small" id="hint">Carregue um .osu mania para ver a preview.</div>
  </section>
</div>

<!-- JSZip (minificado via CDN) -->
<script>
/* JSZip loader (sem depender de build). */
(async function loadJSZip(){
  if (window.JSZip) return;
  const s=document.createElement('script');
  s.src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js";
  s.crossOrigin="anonymous";
  document.head.appendChild(s);
  await new Promise(r=>s.onload=r);
})();
</script>

<script>
  // ---------------------------
  // Estado
  // ---------------------------
  const state = {
    osuText: "",
    osuName: "",
    audioBlob: null,
    audioName: "",
    bgBlob: null,
    bgName: "",
    keys: 0,
    objects: [], // {t, lane, end?, type:'note'|'hold'}
    timingPoints: [], // {t, msPerBeat, uninherited}
    audio: null, // HTMLAudioElement
    playing: false,
    durationMs: 0,
    t0: 0, // current time in ms
    raf: 0
  };

  // ---------------------------
  // Helpers
  // ---------------------------
  const $ = sel => document.querySelector(sel);

  function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }

  function msToStr(ms){
    ms = Math.max(0, ms|0);
    const m = Math.floor(ms/60000);
    const s = Math.floor((ms%60000)/1000);
    const r = ms%1000;
    return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}.${String(r).padStart(3,'0')}`;
  }

  function setStatus(){
    $("#sMap").textContent = state.osuName || "nenhum";
    $("#sAudio").textContent = state.audioName || "nenhum";
    $("#sBg").textContent = state.bgName || "nenhum";
  }

  function estimateBpm(){
    // Bem simples: pega primeiro timing point uninherited e calcula BPM
    const tp = state.timingPoints.find(x=>x.uninherited);
    if(!tp || !isFinite(tp.msPerBeat) || tp.msPerBeat<=0) return null;
    return 60000 / tp.msPerBeat;
  }

  // ---------------------------
  // Parser .osu (mania)
  // ---------------------------
  function parseOsu(text){
    const lines = text.split(/\r?\n/);
    let section = "";
    let mode = null;
    let circleSize = null;
    const timingPoints = [];
    const objects = [];
    let bgCandidate = null;

    for (const raw of lines){
      const line = raw.trim();
      if(!line || line.startsWith("//")) continue;
      const m = line.match(/^\[(.+)\]$/);
      if(m){ section = m[1]; continue; }

      if(section === "General"){
        // Mode: 3 for mania
        if(line.startsWith("Mode:")) mode = Number(line.split(":")[1]);
      }
      if(section === "Difficulty"){
        if(line.startsWith("CircleSize:")) circleSize = Number(line.split(":")[1]);
      }
      if(section === "Events"){
        // Background: 0,0,"bg.jpg",0,0
        // ou Video: 1, ...
        // Vamos pegar o primeiro evento de background (2º campo 0 e tem string)
        const parts = line.split(",");
        if(parts.length>=3){
          const type = parts[0].trim();
          // Em osu!, o background costuma vir como: 0,0,"filename",0,0
          if(type === "0" && parts[1].trim() === "0"){
            const name = parts[2].trim().replace(/^"|"$/g,"");
            if(name && !bgCandidate) bgCandidate = name;
          }
        }
      }
      if(section === "TimingPoints"){
        // time, beatLength, meter, sampleSet, sampleIndex, volume, uninherited, effects
        const parts = line.split(",").map(x=>x.trim());
        if(parts.length >= 2){
          const t = Number(parts[0]);
          const beatLength = Number(parts[1]);
          const uninherited = parts[6] ? parts[6].trim() === "1" : true;
          if(isFinite(t) && isFinite(beatLength)){
            timingPoints.push({ t, msPerBeat: beatLength, uninherited });
          }
        }
      }
      if(section === "HitObjects"){
        // mania: x,y,time,type,hitSound,objectParams,hitSample
        const parts = line.split(",").map(x=>x.trim());
        if(parts.length >= 5){
          const x = Number(parts[0]);
          const time = Number(parts[2]);
          const type = Number(parts[3]);
          if(!isFinite(x) || !isFinite(time) || !isFinite(type)) continue;

          // lane calc: x em [0..512). Keys = CircleSize.
          // lane = floor(x * keys / 512)
          const keys = circleSize || 4;
          const lane = clamp(Math.floor(x * keys / 512), 0, keys-1);

          const isHold = (type & 128) !== 0; // 128 = hold
          if(isHold){
            // objectParams: endTime:... (primeira parte antes de ':')
            const objParams = parts[5] || "";
            const endStr = objParams.split(":")[0];
            const endTime = Number(endStr);
            if(isFinite(endTime)){
              objects.push({ t: time, lane, end: endTime, kind:"hold" });
            }else{
              objects.push({ t: time, lane, kind:"note" });
            }
          }else{
            objects.push({ t: time, lane, kind:"note" });
          }
        }
      }
    }

    return {
      mode, keys: circleSize || 0, objects,
      timingPoints,
      bgSuggested: bgCandidate
    };
  }

  // ---------------------------
  // Preview Canvas (piano-roll)
  // ---------------------------
  const cv = $("#cv");
  const ctx = cv.getContext("2d");

  function clearCanvas(){
    ctx.clearRect(0,0,cv.width,cv.height);
  }

  function draw(){
    clearCanvas();

    const keys = state.keys || 0;
    const objs = state.objects || [];
    const win = Number($("#windowMs").value) || 12000;

    // fundo sutil
    ctx.fillStyle = "rgba(255,255,255,0.03)";
    ctx.fillRect(0,0,cv.width,cv.height);

    if(keys <= 0 || objs.length === 0){
      // grid vazio
      ctx.fillStyle = "rgba(255,255,255,0.12)";
      ctx.font = "14px ui-sans-serif,system-ui";
      ctx.fillText("Carregue um .osu mania para ver a preview.", 18, 32);
      return;
    }

    const pad = 18;
    const w = cv.width - pad*2;
    const h = cv.height - pad*2;

    // tempo atual como centro da janela
    const tCenter = state.t0 || 0;
    const tStart = tCenter - win*0.35; // mais “ahead” do que “behind”
    const tEnd   = tCenter + win*0.65;

    // colunas
    const colW = w / keys;

    // grid colunas
    ctx.strokeStyle = "rgba(255,255,255,0.08)";
    ctx.lineWidth = 1;
    for(let k=0;k<=keys;k++){
      const x = pad + k*colW;
      ctx.beginPath();
      ctx.moveTo(x, pad);
      ctx.lineTo(x, pad+h);
      ctx.stroke();
    }

    // ticks de tempo (a cada 1s)
    const tick = 1000;
    const firstTick = Math.floor(tStart / tick) * tick;
    ctx.strokeStyle = "rgba(255,255,255,0.06)";
    for(let t=firstTick; t<=tEnd; t+=tick){
      const x = pad + (t - tStart) / (tEnd - tStart) * w;
      ctx.beginPath();
      ctx.moveTo(x, pad);
      ctx.lineTo(x, pad+h);
      ctx.stroke();
    }

    // desenhar objetos
    // (nota: sem cores fixas, mas vamos variar alpha por tipo)
    for(const o of objs){
      if(o.t > tEnd + 2000) break; // objs ordenados
      if(o.t < tStart - 2000) continue;

      const x0 = pad + o.lane * colW + 2;
      const x1 = pad + (o.lane+1) * colW - 2;

      const y = (t)=> pad + (t - tStart) / (tEnd - tStart) * h;

      if(o.kind === "hold" && isFinite(o.end)){
        const y1 = y(o.t);
        const y2 = y(o.end);
        const top = Math.min(y1,y2);
        const hh = Math.abs(y2-y1);
        ctx.fillStyle = "rgba(122,162,255,0.25)";
        ctx.fillRect(x0, top, x1-x0, Math.max(3, hh));
        ctx.fillStyle = "rgba(122,162,255,0.5)";
        ctx.fillRect(x0, y1-2, x1-x0, 4);
      } else {
        const yy = y(o.t);
        ctx.fillStyle = "rgba(119,242,198,0.35)";
        ctx.fillRect(x0, yy-3, x1-x0, 6);
      }
    }

    // linha do tempo atual (tCenter)
    const xNow = pad + (tCenter - tStart) / (tEnd - tStart) * w;
    ctx.strokeStyle = "rgba(255,255,255,0.55)";
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(xNow, pad);
    ctx.lineTo(xNow, pad+h);
    ctx.stroke();

    // legenda
    ctx.fillStyle = "rgba(255,255,255,0.75)";
    ctx.font = "12px ui-sans-serif,system-ui";
    ctx.fillText(`t=${msToStr(tCenter)}  window=${win}ms`, pad, pad-6);
  }

  // ---------------------------
  // Audio controls
  // ---------------------------
  function ensureAudio(){
    if(!state.audio){
      state.audio = new Audio();
      state.audio.preload = "metadata";
      state.audio.addEventListener("loadedmetadata", ()=>{
        state.durationMs = Math.floor(state.audio.duration * 1000) || 0;
      });
      state.audio.addEventListener("timeupdate", ()=>{
        if(state.playing){
          state.t0 = Math.floor(state.audio.currentTime * 1000);
          syncSeekBar();
        }
      });
      state.audio.addEventListener("ended", ()=>{
        state.playing = false;
        $("#btnPlay").textContent = "Play";
      });
    }
    return state.audio;
  }

  function syncSeekBar(){
    const max = Number($("#seek").max);
    const dur = state.durationMs || 1;
    const v = Math.floor((state.t0 / dur) * max);
    $("#seek").value = clamp(v, 0, max);
    $("#timeLabel").textContent = msToStr(state.t0);
  }

  function setTimeMs(ms){
    state.t0 = Math.max(0, ms|0);
    $("#timeLabel").textContent = msToStr(state.t0);
    if(state.audio && isFinite(state.audio.duration)){
      state.audio.currentTime = state.t0 / 1000;
    }
    syncSeekBar();
    draw();
  }

  function playPause(){
    if(!state.audioName){
      // sem áudio: “simula” play só pela linha do tempo
      state.playing = !state.playing;
      $("#btnPlay").textContent = state.playing ? "Pause" : "Play";
      if(state.playing) startRAF();
      return;
    }
    const a = ensureAudio();
    if(!a.src) return;
    state.playing = !state.playing;
    $("#btnPlay").textContent = state.playing ? "Pause" : "Play";
    if(state.playing){
      a.play();
      startRAF();
    }else{
      a.pause();
      stopRAF();
    }
  }

  function stop(){
    state.playing = false;
    $("#btnPlay").textContent = "Play";
    if(state.audio){
      state.audio.pause();
      state.audio.currentTime = 0;
    }
    setTimeMs(0);
    stopRAF();
  }

  function startRAF(){
    stopRAF();
    const step = (ts)=>{
      if(!state.playing){ stopRAF(); return; }
      // sem áudio: avança 16ms por frame aprox
      if(!state.audioName){
        state.t0 += 16;
        syncSeekBar();
      }
      draw();
      state.raf = requestAnimationFrame(step);
    };
    state.raf = requestAnimationFrame(step);
  }

  function stopRAF(){
    if(state.raf) cancelAnimationFrame(state.raf);
    state.raf = 0;
  }

  // ---------------------------
  // Export ZIP
  // ---------------------------
  async function exportZip(){
    if(!state.osuText){
      alert("Carregue um .osu primeiro.");
      return;
    }
    if(!window.JSZip){
      alert("JSZip ainda carregando. Tente de novo em 1 segundo.");
      return;
    }

    const packName = ($("#packName").value || "MeuPack_Mania").trim().replace(/[<>:"/\\|?*\x00-\x1F]/g,"_");
    const zip = new JSZip();
    const folder = zip.folder(packName);

    // mapa
    folder.file(state.osuName || "mapa.osu", state.osuText);

    // áudio
    if(state.audioBlob && state.audioName){
      folder.file(state.audioName, state.audioBlob);
    }

    // bg
    if(state.bgBlob && state.bgName){
      folder.file(state.bgName, state.bgBlob);
    }

    // readme
    const bpm = estimateBpm();
    const readme =
`Pack gerado pelo osu!mania Pack Builder (MVP)

Arquivos incluídos:
- ${state.osuName || "mapa.osu"}
- áudio: ${state.audioName || "(nenhum)"}
- bg: ${state.bgName || "(nenhum)"}

Meta:
- Keys: ${state.keys || "?"}
- Objects: ${state.objects?.length || 0}
- BPM (estimado): ${bpm ? bpm.toFixed(2) : "?"}
`;
    folder.file("readme.txt", readme);

    const blob = await zip.generateAsync({type:"blob"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `${packName}.zip`;
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 2000);
  }

  // ---------------------------
  // Wire UI
  // ---------------------------
  $("#osuFile").addEventListener("change", async (e)=>{
    const f = e.target.files?.[0];
    if(!f) return;

    const text = await f.text();
    state.osuText = text;
    state.osuName = f.name;

    const parsed = parseOsu(text);
    if(parsed.mode !== 3){
      alert("Esse .osu não parece ser mania (Mode != 3). Ainda vou carregar, mas a preview pode ficar errada.");
    }
    state.keys = parsed.keys || 0;
    state.objects = (parsed.objects || []).slice().sort((a,b)=>a.t-b.t);
    state.timingPoints = (parsed.timingPoints || []).slice().sort((a,b)=>a.t-b.t);

    $("#metaKeys").textContent = `Keys: ${state.keys || "?"}`;
    $("#metaObjects").textContent = `Objects: ${state.objects.length}`;
    const bpm = estimateBpm();
    $("#metaBpm").textContent = `BPM: (estimado) ${bpm ? bpm.toFixed(2) : "-"}`;

    // dica de BG
    if(parsed.bgSuggested && !state.bgName){
      $("#hint").textContent = `Dica: o mapa sugere BG "${parsed.bgSuggested}". Se você quiser, carregue esse arquivo em Background.`;
    }else{
      $("#hint").textContent = "";
    }

    // reset tempo e duração sem áudio
    state.durationMs = state.objects.length ? (state.objects[state.objects.length-1].end || state.objects[state.objects.length-1].t) + 2000 : 0;
    syncSeekBar();
    setStatus();
    draw();
  });

  $("#audioFile").addEventListener("change", async (e)=>{
    const f = e.target.files?.[0];
    if(!f) return;
    state.audioBlob = f;
    state.audioName = f.name;

    const a = ensureAudio();
    a.src = URL.createObjectURL(f);
    a.load();

    setStatus();
  });

  $("#bgFile").addEventListener("change", async (e)=>{
    const f = e.target.files?.[0];
    if(!f) return;
    state.bgBlob = f;
    state.bgName = f.name;
    setStatus();
  });

  $("#btnPlay").addEventListener("click", playPause);
  $("#btnStop").addEventListener("click", stop);

  $("#seek").addEventListener("input", (e)=>{
    const max = Number(e.target.max);
    const v = Number(e.target.value);
    const dur = state.durationMs || 1;
    const ms = Math.floor((v/max) * dur);
    setTimeMs(ms);
  });

  $("#windowMs").addEventListener("input", ()=> draw());
  $("#exportZip").addEventListener("click", exportZip);

  $("#resetAll").addEventListener("click", ()=>{
    stop();
    state.osuText=""; state.osuName="";
    state.audioBlob=null; state.audioName="";
    state.bgBlob=null; state.bgName="";
    state.keys=0; state.objects=[]; state.timingPoints=[];
    $("#osuFile").value=""; $("#audioFile").value=""; $("#bgFile").value="";
    $("#metaKeys").textContent="Keys: -";
    $("#metaObjects").textContent="Objects: -";
    $("#metaBpm").textContent="BPM: (estimado) -";
    $("#hint").textContent="Carregue um .osu mania para ver a preview.";
    setStatus();
    draw();
  });

  // atalhos
  window.addEventListener("keydown", (e)=>{
    if(e.target && (e.target.tagName==="INPUT" || e.target.tagName==="TEXTAREA")) return;
    if(e.code==="Space"){ e.preventDefault(); playPause(); }
    if(e.code==="ArrowLeft"){ e.preventDefault(); setTimeMs(state.t0 - 500); }
    if(e.code==="ArrowRight"){ e.preventDefault(); setTimeMs(state.t0 + 500); }
  });

  // primeira render
  setStatus();
  draw();
</script>
</body>
</html>

<!doctype html>
<html lang="pt-BR">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Gravador leve (controle total)</title>
<style>
  :root{--bg:#0f1115;--fg:#e6e6e6;--mut:#9aa4b2;--bd:#2a3140;--p:#161a22}
  body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui;min-height:100vh;display:grid;place-items:center}
  .wrap{width:min(960px,92vw);display:grid;gap:12px}
  .bar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;background:var(--p);border:1px solid var(--bd);border-radius:14px;padding:12px}
  button,select{background:#0f131b;border:1px solid var(--bd);color:var(--fg);border-radius:12px;padding:10px 12px;font-weight:650}
  button{cursor:pointer} button:disabled{opacity:.5;cursor:not-allowed}
  label{display:flex;gap:8px;align-items:center;background:#0f131b;border:1px solid var(--bd);border-radius:12px;padding:10px 12px;color:var(--fg)}
  small{color:var(--mut)}
  .sp{flex:1}
  video{width:100%;max-height:70vh;background:#000;border:1px solid var(--bd);border-radius:16px}
  .hint{background:var(--p);border:1px solid var(--bd);border-radius:14px;padding:12px;color:var(--mut);line-height:1.45}
  .pill{padding:6px 10px;border:1px solid var(--bd);border-radius:999px;color:var(--mut)}
</style>

<div class="wrap">
  <div class="bar">
    <button id="start">Iniciar</button>
    <button id="stop" disabled>Parar</button>
    <button id="down" disabled>Baixar</button>

    <div class="sp"></div>

    <select id="res" title="Resolução">
      <option value="native" selected>Nativo</option>
      <option value="1920x1080">1080p</option>
      <option value="1280x720">720p (recomendado)</option>
      <option value="960x540">540p (bem leve)</option>
      <option value="854x480">480p (ultra leve)</option>
    </select>

    <select id="fps" title="FPS">
      <option value="15">15</option>
      <option value="20">20</option>
      <option value="24" selected>24 (bom e leve)</option>
      <option value="30">30</option>
      <option value="60">60 (pesa muito)</option>
    </select>

    <select id="br" title="Qualidade (bitrate)">
      <option value="800000">0.8 Mbps (leve)</option>
      <option value="1200000">1.2 Mbps (ok)</option>
      <option value="1800000" selected>1.8 Mbps (limpo/leve)</option>
      <option value="2500000">2.5 Mbps (limpo)</option>
      <option value="4000000">4 Mbps (pesa)</option>
      <option value="6000000">6 Mbps (pesa muito)</option>
    </select>

    <label title="Na janela do Chrome/Edge marque 'Compartilhar áudio'">
      <input id="audio" type="checkbox"> Áudio
    </label>

    <label title="Ajuda muito no desempenho">
      <input id="noPreview" type="checkbox" checked> Sem preview gravando
    </label>

    <span id="st" class="pill">Parado</span>
  </div>

  <video id="v" controls playsinline></video>

  <div class="hint">
    <b>Pra osu! ficar suave:</b> escolha <b>Janela → osu!</b> (evite Tela inteira).  
    Preset que costuma ficar “limpo sem travar”: <b>720p • 24fps • 1.8 Mbps • Sem preview</b>.  
    Se ainda travar: desce para <b>540p</b> ou <b>20fps</b>. Áudio também pode pesar um pouco.
  </div>
</div>

<script>
let rec=null, chunks=[], blob=null, stream=null;

const $=id=>document.getElementById(id);
const setSt=t=>$("st").textContent=t;

function pickMime(){
  const c=[
    "video/webm;codecs=vp9,opus",
    "video/webm;codecs=vp8,opus",
    "video/webm;codecs=vp9",
    "video/webm;codecs=vp8",
    "video/webm"
  ];
  return c.find(x=>MediaRecorder.isTypeSupported(x)) || "";
}

function stopAll(){
  try{ stream?.getTracks().forEach(t=>t.stop()); }catch(e){}
  stream=null;
}

function parseRes(val){
  if(val==="native") return null;
  const [w,h]=val.split("x").map(n=>parseInt(n,10));
  return {w,h};
}

$("start").onclick = async () => {
  blob=null; chunks=[]; $("down").disabled=true;

  const fps = parseInt($("fps").value,10);
  const br  = parseInt($("br").value,10);
  const wantAudio = $("audio").checked;
  const noPreview = $("noPreview").checked;
  const r = parseRes($("res").value);

  // Preview durante a gravação custa (decodificar/mostrar vídeo); desligar ajuda muito.
  if(noPreview){
    $("v").removeAttribute("src");
    $("v").load();
  }

  const videoConstraints = {
    frameRate: { ideal: fps, max: fps }
  };
  if(r){
    videoConstraints.width  = { ideal: r.w };
    videoConstraints.height = { ideal: r.h };
  }

  try{
    stream = await navigator.mediaDevices.getDisplayMedia({
      video: videoConstraints,
      audio: wantAudio
    });
  }catch(e){
    setSt("Cancelado/erro");
    return;
  }

  const mimeType = pickMime();
  const opts = {
    mimeType: mimeType || undefined,
    videoBitsPerSecond: br
  };

  try{
    rec = new MediaRecorder(stream, opts);
  }catch(e){
    stopAll();
    setSt("Erro: MediaRecorder");
    return;
  }

  rec.ondataavailable = (e)=>{ if(e.data && e.data.size) chunks.push(e.data); };
  rec.onstop = ()=>{
    blob = new Blob(chunks,{type: rec.mimeType || "video/webm"});
    if(noPreview){
      $("v").src = URL.createObjectURL(blob);
    }else{
      // se preview estava ligado, ainda atualiza normal
      $("v").src = URL.createObjectURL(blob);
    }
    $("down").disabled=false;
  };

  // Se parar o compartilhamento pelo navegador
  stream.getVideoTracks()[0].addEventListener("ended", ()=>{ if(rec?.state==="recording") $("stop").click(); });

  // Chunk mais longo = menos overhead.
  rec.start(1000);

  $("start").disabled=true;
  $("stop").disabled=false;
  setSt("Gravando… (use Janela → osu!)");
};

$("stop").onclick = () => {
  try{ if(rec && rec.state==="recording") rec.stop(); }catch(e){}
  stopAll();
  $("start").disabled=false;
  $("stop").disabled=true;
  setSt("Parado");
};

$("down").onclick = () => {
  if(!blob) return;
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="gravacao.webm";
  a.click();
};
</script>
</html>

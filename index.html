<!doctype html>
<html lang="pt-BR">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Gravador leve (osu!)</title>
<style>
  body{margin:0;background:#0f1115;color:#e6e6e6;font-family:system-ui;display:grid;place-items:center;min-height:100vh}
  .box{width:min(820px,92vw);display:grid;gap:12px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  button,select,label{background:#161a22;border:1px solid #2a3140;color:#e6e6e6;border-radius:10px;padding:10px 12px;font-weight:600}
  button{cursor:pointer} button:disabled{opacity:.5;cursor:not-allowed}
  label{display:flex;gap:8px;align-items:center;font-weight:500}
  video{width:100%;max-height:70vh;background:#000;border:1px solid #2a3140;border-radius:14px}
  #s{opacity:.85}
</style>

<div class="box">
  <div class="row">
    <button id="start">Iniciar</button>
    <button id="stop" disabled>Parar</button>
    <button id="down" disabled>Baixar</button>

    <select id="mode" title="Qualidade">
      <option value="ultra" selected>Ultra leve (osu!)</option>
      <option value="normal">Normal</option>
    </select>

    <label title="Depende de marcar 'Compartilhar áudio' na janela do navegador">
      <input id="sys" type="checkbox" checked> som do sistema
    </label>

    <span id="s">Parado</span>
  </div>

  <video id="v" controls playsinline></video>
</div>

<script>
let rec, chunks=[], blob=null, stream=null;

const $=id=>document.getElementById(id);
const S=t=>$("s").textContent=t;

function mime(){
  const c=["video/webm;codecs=vp8,opus","video/webm;codecs=vp8","video/webm"];
  return c.find(x=>MediaRecorder.isTypeSupported(x))||"video/webm";
}

$("start").onclick = async () => {
  blob=null; chunks=[]; $("down").disabled=true;

  const ultra = $("mode").value==="ultra";
  const wantAudio = $("sys").checked;

  // Otimizado pra não travar o osu!: 720p + ~20fps + bitrate baixo
  const videoConstraints = ultra ? {
    frameRate:{ideal:20,max:20},
    width:{ideal:1280},
    height:{ideal:720}
  } : {
    frameRate:{ideal:30,max:30}
  };

  try{
    stream = await navigator.mediaDevices.getDisplayMedia({
      video: videoConstraints,
      audio: wantAudio
    });
  }catch(e){
    S("Cancelado/erro");
    return;
  }

  const bits = ultra ? 900000 : 2500000; // 0.9 Mbps vs 2.5 Mbps
  rec = new MediaRecorder(stream,{ mimeType:mime(), videoBitsPerSecond:bits });

  rec.ondataavailable = e => { if(e.data.size) chunks.push(e.data); };
  rec.onstop = () => {
    blob = new Blob(chunks,{type:rec.mimeType});
    $("v").src = URL.createObjectURL(blob);
    $("down").disabled = false;
  };

  // Se você parar o compartilhamento pelo navegador, para aqui também
  stream.getVideoTracks()[0].addEventListener("ended", ()=>{ if(rec?.state==="recording") $("stop").click(); });

  rec.start(300);
  $("start").disabled=true; $("stop").disabled=false;
  S("Gravando… (dica: escolha a JANELA do osu!, não tela inteira)");
};

$("stop").onclick = () => {
  try{ if(rec && rec.state==="recording") rec.stop(); }catch(e){}
  stream?.getTracks().forEach(t=>t.stop());
  stream=null;
  $("start").disabled=false; $("stop").disabled=true;
  S("Parado");
};

$("down").onclick = () => {
  if(!blob) return;
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="osu_gravacao.webm";
  a.click();
};
</script>
</html>

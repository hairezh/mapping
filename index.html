<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Gravador de Tela (leve + áudio)</title>
<style>
  :root{
    --bg:#0f1115; --fg:#e6e6e6; --muted:#9aa4b2; --panel:#161a22; --border:#2a3140;
    --good:#6ee7b7; --warn:#fbbf24; --bad:#fb7185; --link:#7aa2ff;
  }
  body{
    margin:0; background:var(--bg); color:var(--fg);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
    min-height:100vh; display:flex; align-items:center; justify-content:center;
  }
  .wrap{ width:min(980px, 96vw); padding:18px; display:grid; gap:14px; grid-template-columns: 360px 1fr; }
  @media (max-width: 860px){ .wrap{ grid-template-columns:1fr; } }
  .card{
    background:var(--panel); border:1px solid var(--border); border-radius:14px;
    padding:14px; box-shadow:0 10px 30px rgba(0,0,0,.25);
  }
  h1{ font-size:18px; margin:0 0 10px; }
  .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
  label{ font-size:12px; color:var(--muted); display:flex; gap:8px; align-items:center; }
  select, input[type="number"]{
    width:100%; padding:10px 10px; border-radius:10px; border:1px solid var(--border);
    background:#0f131b; color:var(--fg); outline:none;
  }
  .btn{
    padding:11px 14px; border-radius:12px; border:1px solid var(--border);
    background:#111827; color:var(--fg); cursor:pointer; font-weight:600;
  }
  .btn:hover{ filter:brightness(1.08); }
  .btn:disabled{ opacity:.45; cursor:not-allowed; }
  .btn.primary{ background:#1f2a44; border-color:#33456d; }
  .btn.danger{ background:#3a1118; border-color:#6b1f2a; }
  .pill{
    font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid var(--border);
    color:var(--muted);
  }
  .pill.live{ color:var(--good); border-color:rgba(110,231,183,.35); }
  .pill.warn{ color:var(--warn); border-color:rgba(251,191,36,.35); }
  .hint{ font-size:12px; color:var(--muted); line-height:1.45; }
  .hint b{ color:var(--fg); }
  video{
    width:100%; border-radius:14px; border:1px solid var(--border); background:#000;
    max-height: 68vh;
  }
  a{ color:var(--link); }
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Gravador de Tela (leve + áudio)</h1>

      <div class="row" style="margin-bottom:10px">
        <span id="status" class="pill">Parado</span>
        <span id="info" class="pill">—</span>
      </div>

      <div class="grid">
        <div>
          <label>FPS</label>
          <select id="fps">
            <option value="24">24 (cinema, leve)</option>
            <option value="30" selected>30 (bom/normal)</option>
            <option value="60">60 (pesado)</option>
          </select>
        </div>
        <div>
          <label>Qualidade (bitrate)</label>
          <select id="br">
            <option value="1200000">1.2 Mbps (leve)</option>
            <option value="2500000" selected>2.5 Mbps (ok)</option>
            <option value="5000000">5 Mbps (melhor, pesa)</option>
          </select>
        </div>
      </div>

      <div style="height:10px"></div>

      <div class="grid">
        <label><input id="sysAudio" type="checkbox" checked> Gravar <b>som do sistema</b></label>
        <label><input id="micAudio" type="checkbox"> Gravar <b>microfone</b></label>
      </div>

      <div style="height:10px"></div>

      <div class="row">
        <button class="btn primary" id="btnStart">Iniciar</button>
        <button class="btn danger" id="btnStop" disabled>Parar</button>
        <button class="btn" id="btnDownload" disabled>Baixar</button>
      </div>

      <div style="height:12px"></div>

      <div class="hint">
        <b>Som do sistema:</b> na janela de compartilhar tela do Chrome/Edge, marque <b>“Compartilhar áudio”</b> (se aparecer).<br>
        <b>Notebook fraco:</b> começa em <b>30 FPS</b> e <b>2.5 Mbps</b>. Se travar, baixa pra <b>24 FPS</b> e <b>1.2 Mbps</b>.<br>
        Se o vídeo ficar “bonitinho mas sem som”, quase sempre é o checkbox de áudio que não foi marcado.
      </div>
    </div>

    <div class="card">
      <video id="preview" controls playsinline></video>
    </div>
  </div>

<script>
  const $ = (id)=>document.getElementById(id);

  let recorder = null;
  let chunks = [];
  let finalBlob = null;

  let screenStream = null;
  let micStream = null;

  let mixedStream = null;
  let audioCtx = null;

  function setStatus(text, mode=""){
    $("status").textContent = text;
    $("status").className = "pill" + (mode ? " " + mode : "");
  }

  function setInfo(text){ $("info").textContent = text; }

  function stopTracks(stream){
    if(!stream) return;
    stream.getTracks().forEach(t=>t.stop());
  }

  function pickMimeType(){
    const candidates = [
      "video/webm;codecs=vp9,opus",
      "video/webm;codecs=vp8,opus",
      "video/webm;codecs=vp9",
      "video/webm;codecs=vp8",
      "video/webm"
    ];
    for(const t of candidates){
      if(MediaRecorder.isTypeSupported(t)) return t;
    }
    return "";
  }

  async function startRecording(){
    finalBlob = null;
    chunks = [];
    $("btnDownload").disabled = true;

    const fps = parseInt($("fps").value, 10);
    const bitrate = parseInt($("br").value, 10);
    const wantSys = $("sysAudio").checked;
    const wantMic = $("micAudio").checked;

    // 1) Captura da tela
    // OBS: áudio do sistema só vem se o navegador/OS permitir E se o usuário marcar "Compartilhar áudio".
    screenStream = await navigator.mediaDevices.getDisplayMedia({
      video: { frameRate: fps },
      audio: wantSys
    });

    // 2) Captura do microfone (opcional)
    micStream = null;
    if(wantMic){
      micStream = await navigator.mediaDevices.getUserMedia({
        audio: {
          echoCancellation: true,
          noiseSuppression: true,
          autoGainControl: true
        },
        video: false
      });
    }

    // 3) Monta stream final (video da tela + áudio (sistema/mic) mixado)
    const videoTrack = screenStream.getVideoTracks()[0];

    const hasScreenAudio = screenStream.getAudioTracks().length > 0;
    const hasMicAudio = micStream && micStream.getAudioTracks().length > 0;

    // Se só existe um áudio (ou nenhum), não precisa mixar.
    if(!hasScreenAudio && !hasMicAudio){
      mixedStream = new MediaStream([videoTrack]);
      setInfo(`${fps}fps • ${(bitrate/1e6).toFixed(1)}Mbps • sem áudio`);
    } else if(hasScreenAudio && !hasMicAudio){
      mixedStream = new MediaStream([videoTrack, screenStream.getAudioTracks()[0]]);
      setInfo(`${fps}fps • ${(bitrate/1e6).toFixed(1)}Mbps • áudio sistema`);
    } else if(!hasScreenAudio && hasMicAudio){
      mixedStream = new MediaStream([videoTrack, micStream.getAudioTracks()[0]]);
      setInfo(`${fps}fps • ${(bitrate/1e6).toFixed(1)}Mbps • microfone`);
    } else {
      // Mixa os dois áudios via AudioContext
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const dest = audioCtx.createMediaStreamDestination();

      const sysSource = audioCtx.createMediaStreamSource(screenStream);
      sysSource.connect(dest);

      const micSource = audioCtx.createMediaStreamSource(micStream);
      micSource.connect(dest);

      const mixedAudioTrack = dest.stream.getAudioTracks()[0];
      mixedStream = new MediaStream([videoTrack, mixedAudioTrack]);

      setInfo(`${fps}fps • ${(bitrate/1e6).toFixed(1)}Mbps • sistema + mic`);
    }

    const mimeType = pickMimeType();
    const options = {
      mimeType: mimeType || undefined,
      videoBitsPerSecond: bitrate
    };

    recorder = new MediaRecorder(mixedStream, options);

    recorder.ondataavailable = (e)=>{
      if(e.data && e.data.size > 0) chunks.push(e.data);
    };

    recorder.onstop = ()=>{
      finalBlob = new Blob(chunks, { type: recorder.mimeType || "video/webm" });
      $("preview").src = URL.createObjectURL(finalBlob);
      $("btnDownload").disabled = false;
    };

    // se o usuário parar o compartilhamento por fora, para a gravação também
    screenStream.getVideoTracks()[0].addEventListener("ended", ()=>{
      if(recorder && recorder.state === "recording") stopRecording();
    });

    recorder.start(250); // coleta chunks a cada 250ms
    setStatus("Gravando…", "live");
    $("btnStart").disabled = true;
    $("btnStop").disabled = false;
  }

  function stopRecording(){
    try{
      if(recorder && recorder.state === "recording") recorder.stop();
    }catch(e){}

    setStatus("Parado");
    $("btnStart").disabled = false;
    $("btnStop").disabled = true;

    stopTracks(screenStream);
    stopTracks(micStream);
    stopTracks(mixedStream);

    screenStream = null;
    micStream = null;
    mixedStream = null;

    if(audioCtx){
      try{ audioCtx.close(); }catch(e){}
      audioCtx = null;
    }
  }

  function download(){
    if(!finalBlob) return;

    const a = document.createElement("a");
    a.href = URL.createObjectURL(finalBlob);
    const dt = new Date();
    const pad = (n)=>String(n).padStart(2,"0");
    const name = `gravacao_${dt.getFullYear()}-${pad(dt.getMonth()+1)}-${pad(dt.getDate())}_${pad(dt.getHours())}-${pad(dt.getMinutes())}.webm`;
    a.download = name;
    a.click();
  }

  $("btnStart").addEventListener("click", async ()=>{
    try{
      await startRecording();
    }catch(err){
      console.error(err);
      setStatus("Erro", "warn");
      setInfo("Permissão negada ou navegador não suportou.");
      $("btnStart").disabled = false;
      $("btnStop").disabled = true;
    }
  });

  $("btnStop").addEventListener("click", ()=> stopRecording());
  $("btnDownload").addEventListener("click", ()=> download());
</script>
</body>
</html>
